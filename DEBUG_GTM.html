<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Clone Tracker</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
        }
        .log {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        .error { color: #ff0000; border-color: #ff0000; }
        .success { color: #00ff00; border-color: #00ff00; }
        .info { color: #ffff00; border-color: #ffff00; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
            font-family: monospace;
            font-size: 16px;
        }
        button:hover {
            background: #00cc00;
        }
    </style>
</head>
<body>
    <h1>üîç Debug Clone Tracker - GTM</h1>
    <p>Use este arquivo para testar o envio de dados do site clonado</p>

    <button onclick="testCORS()">1Ô∏è‚É£ Testar CORS</button>
    <button onclick="testEndpoint()">2Ô∏è‚É£ Testar Endpoint</button>
    <button onclick="testFullScript()">3Ô∏è‚É£ Testar Script Completo</button>
    <button onclick="clearLogs()">üóëÔ∏è Limpar Logs</button>

    <div id="logs"></div>

    <script>
        const COLLECTOR_URL = 'https://cc-sorteador.on-forge.com/api/collect';
        const logsDiv = document.getElementById('logs');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = 'log ' + type;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.insertBefore(div, logsDiv.firstChild);
        }

        function clearLogs() {
            logsDiv.innerHTML = '';
            log('Logs limpos', 'info');
        }

        // Teste 1: Verificar se o CORS est√° permitindo requisi√ß√µes
        async function testCORS() {
            log('üîç Testando CORS...', 'info');

            try {
                const response = await fetch(COLLECTOR_URL, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type',
                    }
                });

                log(`‚úÖ CORS Preflight: ${response.status}`, 'success');

                const headers = {};
                for (let [key, value] of response.headers.entries()) {
                    if (key.includes('access-control')) {
                        headers[key] = value;
                    }
                }

                log(`üìã Headers CORS: ${JSON.stringify(headers, null, 2)}`, 'info');

                if (response.ok) {
                    log('‚úÖ CORS est√° configurado corretamente!', 'success');
                } else {
                    log('‚ùå CORS pode estar bloqueando. Status: ' + response.status, 'error');
                }

            } catch (error) {
                log('‚ùå Erro no teste de CORS: ' + error.message, 'error');
                log('üí° Isso pode indicar que o CORS est√° bloqueando completamente', 'info');
            }
        }

        // Teste 2: Testar envio real de dados
        async function testEndpoint() {
            log('üì§ Enviando dados de teste...', 'info');

            const testData = {
                sessionId: 'debug_test_' + Date.now(),
                domain: window.location.hostname || 'localhost',
                url: window.location.href,
                referrer: document.referrer || '',
                screenResolution: screen.width + 'x' + screen.height,
                language: navigator.language,
                timestamp: new Date().toISOString(),
                requests: [
                    {
                        type: 'debug_test',
                        message: 'Teste de debug do site: ' + window.location.hostname,
                        timestamp: new Date().toISOString()
                    }
                ]
            };

            log('üì¶ Payload: ' + JSON.stringify(testData, null, 2), 'info');

            try {
                const response = await fetch(COLLECTOR_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData),
                    mode: 'cors'
                });

                log(`üì° Status HTTP: ${response.status} ${response.statusText}`,
                    response.ok ? 'success' : 'error');

                const responseData = await response.json();
                log('üì® Resposta: ' + JSON.stringify(responseData, null, 2),
                    responseData.status === 'success' ? 'success' : 'error');

                if (responseData.status === 'success') {
                    log(`üéâ SUCESSO! Dados enviados com ID: ${responseData.id}`, 'success');
                    log('‚úÖ O endpoint est√° funcionando corretamente neste site!', 'success');
                } else {
                    log('‚ùå Resposta de erro do servidor', 'error');
                }

            } catch (error) {
                log('‚ùå Erro ao enviar: ' + error.message, 'error');
                log('üí° Detalhes do erro: ' + error.toString(), 'error');

                if (error.message.includes('CORS')) {
                    log('üîß SOLU√á√ÉO: Configure o CORS no servidor Laravel', 'info');
                    log('   - Adicione o dom√≠nio atual aos allowed_origins', 'info');
                    log('   - Dom√≠nio atual: ' + window.location.origin, 'info');
                }
            }
        }

        // Teste 3: Testar script completo (vers√£o simplificada)
        async function testFullScript() {
            log('üöÄ Testando script completo...', 'info');

            let capturedRequests = [];

            // Simular captura de eventos
            log('üì∏ Capturando evento de p√°gina...', 'info');
            capturedRequests.push({
                type: 'page_load',
                url: window.location.href,
                timestamp: new Date().toISOString()
            });

            // Simular clique
            log('üñ±Ô∏è Simulando clique...', 'info');
            capturedRequests.push({
                type: 'click',
                tagName: 'BUTTON',
                text: 'Teste de Debug',
                timestamp: new Date().toISOString()
            });

            // Enviar dados
            const data = {
                sessionId: 'full_script_test_' + Date.now(),
                domain: window.location.hostname || 'localhost',
                url: window.location.href,
                referrer: document.referrer || '',
                screenResolution: screen.width + 'x' + screen.height,
                language: navigator.language,
                timestamp: new Date().toISOString(),
                requests: capturedRequests
            };

            log('üì¶ Enviando ' + capturedRequests.length + ' eventos...', 'info');

            try {
                const response = await fetch(COLLECTOR_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                    mode: 'cors'
                });

                const responseData = await response.json();

                if (responseData.status === 'success') {
                    log('üéâ Script completo funcionando! ID: ' + responseData.id, 'success');
                } else {
                    log('‚ùå Script retornou erro: ' + JSON.stringify(responseData), 'error');
                }

            } catch (error) {
                log('‚ùå Erro no script: ' + error.message, 'error');
            }
        }

        // Informa√ß√µes do ambiente
        log('üåç Dom√≠nio atual: ' + window.location.hostname, 'info');
        log('üìç URL atual: ' + window.location.href, 'info');
        log('üéØ Endpoint: ' + COLLECTOR_URL, 'info');
        log('', 'info');
        log('üëÜ Clique nos bot√µes acima para testar', 'info');
    </script>
</body>
</html>
